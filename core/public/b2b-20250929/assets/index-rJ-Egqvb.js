import{j as n,w as Z,G as X,z as se,A as pe,ae as ye,T as te,B as K,I as ae}from"./mui-DjJKBaL-.js";import{r}from"./intl-D34a3Rgg.js";import{j as J,C as ge,l as he,a as ee,aa as ne,ck as Ie,cl as xe,u as M,B as P,aI as be,ai as Q,ad as ce,ak as de,I as Ce,ao as ue,at as re,al as Ne,ah as Re,a2 as Ee,bI as Ue,af as Se}from"./react-setup-B5wPcSA9.js";import{B as Fe}from"./B3Filter-DoBVbjfY.js";import"./load-functions-DCmK5p8C.js";import{u as Be,a as ke}from"./useTableRef-CsMdwZmB.js";import{b as je}from"./base-CC7kTJh2.js";import{g as we,e as De,l as Te}from"./lodashEs-CONzB2I0.js";import{D as ve,E as Le,f as $e}from"./muiIcon-BBtg8u0V.js";import{u as qe}from"./form-pKe_k4Gy.js";import{B as Me}from"./B3CustomForm-B2g91-rz.js";import"./reactVendor-CkUTLE5B.js";import"./eCache-97HTO8co.js";import"./redux-Bt5-tVzx.js";import"./toolkit-CpEbzTSY.js";import"../index.js";import"./global-D7Yn0gGb.js";import"./router-DcuTQ_yx.js";import"./dropzone-B1UJxEDf.js";import"./dateFns-DubixNBV.js";import"./B3FilterMore-CBogUOsZ.js";import"./B3FilterSearch-DNW83fPo.js";const Pe=(e,t)=>t in e,Ae=Z("div")(()=>({height:"100%",minHeight:"400px",backgroundColor:"#fff",display:"flex",justifyContent:"center",alignItems:"center",color:"#aaa",fontSize:"18px"})),Oe=Z("span")(()=>({marginLeft:"10px"}));function Ve({isLoading:e}){const t=J();return n.jsxs(Ae,{children:[!e&&n.jsx(ve,{fontSize:"large"}),n.jsx(Oe,{children:e?"":t("global.table.noData")})]})}const Y=e=>"node"in e;function ze({listItems:e,pagination:t,onPaginationChange:c,rowsPerPageOptions:l,renderItem:o,isInfiniteScroll:I,isLoading:i,itemXs:F,showRowsPerPageOptions:E}){const{state:{portalStyle:{backgroundColor:j="#FEF9F5"}}}=r.useContext(ge),B=he(j),[C]=ee(),U=J(),{offset:k,count:y,first:N}=t,x=u=>{i||c(u)},w=(u,R)=>{x({...t,offset:R*N})},d=u=>{x({...t,offset:0,first:parseInt(u.target.value,10)||N})};return e.length>0?n.jsxs(n.Fragment,{children:[I&&n.jsxs(n.Fragment,{children:[n.jsx(X,{container:!0,spacing:2,children:e.map((u,R)=>{const f=Y(u)?u.node:u;return n.jsx(X,{item:!0,xs:12,children:f&&o(f)},"".concat(f.id+R))})}),n.jsx(se,{labelDisplayedRows:({from:u,to:R,count:f})=>U("global.pagination.pageXOfY",{from:u,to:R,count:f}),rowsPerPageOptions:E?l:[],labelRowsPerPage:U("global.pagination.perPage"),component:"div",sx:{color:C?ne(B,.87):"rgba(0, 0, 0, 0.87)",marginTop:"1.5rem","::-webkit-scrollbar":{display:"none"},"& svg":{color:C?ne(B,.87):"rgba(0, 0, 0, 0.87)"}},count:y,rowsPerPage:N,page:N===0?0:k/N,onPageChange:w,onRowsPerPageChange:d})]}),!I&&n.jsxs(n.Fragment,{children:[n.jsx(X,{container:!0,spacing:2,children:e.map((u,R)=>{const f=Y(u)?u.node:u;return n.jsx(X,{item:!0,xs:F,children:f&&o&&o(f)},"".concat(f.id+R))})}),n.jsx(se,{labelDisplayedRows:({from:u,to:R,count:f})=>U("global.pagination.pageXOfY",{from:u,to:R,count:f}),rowsPerPageOptions:E?l:[],labelRowsPerPage:U("global.pagination.cardsPerPage"),component:"div",sx:{color:B,marginTop:"1.5rem","::-webkit-scrollbar":{display:"none"},"& svg":{color:B}},count:y,rowsPerPage:N,page:N===0?0:k/N,onPageChange:w,onRowsPerPageChange:d})]})]}):n.jsx(Ve,{isLoading:i})}function _e({renderItem:e,itemXs:t,getRequestList:c,searchParams:l,requestLoading:o,showRowsPerPageOptions:I=!0},i){const F=[12,24,36],E={offset:0,first:F[0]},{selectCompanyHierarchyId:j}=M(({company:s})=>s.companyHierarchyInfo),B=r.useRef(j),C=r.useRef(null),[U,k]=r.useState(!1),[y,N]=r.useState(E),[x,w]=r.useState(0),[d,u]=r.useState([]),[R,f]=r.useState([]),[L]=ee(),A=r.useCallback(s=>{d.length||u(s);const p=[...d];s.forEach(m=>{const h=Y(m)?m.node:m;d.some(g=>(Y(g)?g.node:g).id===h.id)||p.push(m)}),u(p)},[d]),v=r.useCallback(async(s,p)=>{try{if(C!=null&&C.current&&we(C.current,l)&&!p&&!s)return;C.current=l,k(!0),o&&o(!0);const{createdBy:m=""}=l,h=/\((.+)\)/g,D=/^[^(]+/,g=h.exec(m),T=D.exec(m),a=T!=null&&T.length?T[0].trim():"",S={...{...l,createdBy:a,email:g!=null&&g.length?g[1]:""},first:(s==null?void 0:s.first)||y.first,offset:(s==null?void 0:s.offset)||0},$=await c(S),{edges:H,totalCount:G}=$;f(H),A(H),s||N({first:y.first,offset:0}),w(G),k(!1),o&&o(!1)}catch(m){k(!1),o&&o(!1)}},[A,c,y.first,o,l]),O=r.useCallback(()=>{v(y,!0)},[v,y]);r.useEffect(()=>{const s=Number(B.current)!==Number(j);De(l)||(s?(v(y,!0),B.current=j):v())},[v,l,j,y]);const V=async s=>{await v(s),N(s)},_={...y,count:x},q=r.useCallback(()=>R,[R]),z=r.useCallback(()=>d,[d]);return r.useImperativeHandle(i,()=>({setList:f,setCacheAllList:u,getList:q,getCacheList:z,refresh:O}),[q,z,O]),n.jsx(ze,{listItems:R,pagination:_,rowsPerPageOptions:F,onPaginationChange:V,isInfiniteScroll:L,isLoading:U,renderItem:e,itemXs:t,showRowsPerPageOptions:I})}const He=Ie(xe(_e)),oe=e=>e!==void 0&&e!==""?Number(e):void 0,Ge="\n  mutation CreateUser ($userData: UserInputType!) {\n    userCreate ( userData: $userData ){\n      user {\n        id\n      }\n    }\n  }\n",Qe=e=>{const t={companyId:oe(e.companyId),companyRoleId:oe(e.companyRoleId),email:e.email,firstName:e.firstName,lastName:e.lastName,phone:e.phone,addChannel:e.addChannel,companyRoleName:e.companyRoleName,extraFields:e.extraFields};return P.graphqlB2B({query:Ge,variables:{userData:t}})},le=e=>e!==void 0&&e!==""?Number(e):void 0,Xe="\n  query UserEmailCheck ($email: String!, $companyId: Int, $storeHash: String!, $channelId: Int) {\n    userEmailCheck ( email: $email, companyId: $companyId, storeHash: $storeHash, channelId: $channelId ){\n      userType,\n      userInfo {\n        companyName\n      }\n    }\n  }\n",Ye=e=>P.graphqlB2B({query:Xe,variables:{email:e.email,companyId:le(e.companyId),channelId:le(e.channelId),storeHash:be}}).then(t=>({...t.userEmailCheck,isValid:t.userEmailCheck.userType===Q.DOES_NOT_EXIST})),Je=()=>[{label:"Admin",name:"Admin",value:0,idLang:"userManagement.userRole.admin"},{label:"Senior buyer",name:"Senior Buyer",value:1,idLang:"userManagement.userRole.seniorBuyer"},{label:"Junior buyer",name:"Junior Buyer",value:2,idLang:"userManagement.userRole.juniorBuyer"}],me=e=>[{name:"companyRoleId",label:e("userManagement.config.userRole"),required:!1,default:"",defaultName:"",fieldType:"roleAutocomplete",xs:12,disabled:!1,variant:"filled",size:"small"}],We=(e,t,c=!1)=>{const l=me(t);return l[0].required=!0,l[0].disabled=c,[...l,{name:"email",label:t("userManagement.config.email"),required:!0,fieldType:"text",xs:12,disabled:e==="edit",default:"",variant:"filled",size:"small"},{name:"firstName",label:t("userManagement.config.firstName"),required:!0,default:"",fieldType:"text",xs:6,variant:"filled",size:"small"},{name:"lastName",label:t("userManagement.config.lastName"),required:!0,fieldType:"text",xs:6,default:"",variant:"filled",size:"small"},{name:"phone",label:t("userManagement.config.phoneNumber"),required:!1,fieldType:"text",xs:12,default:"",variant:"filled",size:"small"}]},Ke={3:"global.emailValidate.multipleCustomer",4:"global.emailValidate.companyUsed",5:"global.emailValidate.alreadyExits",6:"global.emailValidate.usedSuperAdmin"},Ze="\n  query GetUser($userId: Int!, $companyId: Int!) {\n    user ( userId: $userId companyId: $companyId ) { \n        firstName,\n        lastName,\n        email,\n        phone,\n        companyRoleId,\n        companyRoleName,\n        extraFields {\n          fieldName\n          fieldValue\n        }\n      }\n    }\n",es=({userId:e,companyId:t})=>P.graphqlB2B({query:Ze,variables:{userId:Number(e),companyId:Number(t)}}).then(({user:c})=>c),ss="\n  query GetUserExtraFields {\n    userExtraFields {\n      fieldName\n      fieldType\n      isRequired\n      defaultValue\n      maximumLength\n      numberOfRows\n      maximumValue\n      listOfValue\n      visibleToEnduser\n      labelName\n    }\n  }\n",ts=()=>P.graphqlB2B({query:ss}),as={0:"text",1:"multiline",2:"number",3:"dropdown"},ns=e=>e.map(c=>{const{listOfValue:l}=c,o=as[c.fieldType],I={isExtraFields:!0,name:c.fieldName,label:c.labelName,required:c.isRequired,default:c.defaultValue||"",fieldType:o,xs:12,variant:"filled",size:"small"};switch(o){case"dropdown":if(l){const i=l==null?void 0:l.map(F=>({label:F,value:F}));i.length>0&&(I.options=i)}break;case"number":I.max=c.maximumValue||"";break;case"multiline":I.rows=c.numberOfRows||"";break;default:I.maxLength=c.maximumLength||"";break}return I}),rs=async()=>{let e=[];try{const{userExtraFields:t}=await ts(),c=t.filter(o=>o.visibleToEnduser);e=ns(c)}catch(t){je.error(t)}return e},W=e=>e!==void 0&&e!==""?Number(e):void 0,os="\n  mutation UpdateUser ($userData: UserUpdateInputType!) {\n    userUpdate ( userData: $userData ) {\n      user {\n        id\n      }\n    }\n  }\n",ls=e=>{const t={userId:W(e.userId),companyId:W(e.companyId),companyRoleId:W(e.companyRoleId),email:e.email,firstName:e.firstName,lastName:e.lastName,phone:e.phone,addChannel:e.addChannel,companyRoleName:e.companyRoleName,extraFields:e.extraFields};return P.graphqlB2B({query:os,variables:{userData:t}})};function is({companyId:e,renderList:t},c){const l=M(({company:s})=>s.customer.b2bId),[o,I]=r.useState(!1),[i,F]=r.useState(""),[E,j]=r.useState(),[B,C]=r.useState(!1),[U,k]=r.useState([]),[y,N]=r.useState([]),x=J(),{control:w,handleSubmit:d,getValues:u,formState:{errors:R},clearErrors:f,setValue:L,setError:A}=qe({mode:"onSubmit"}),v=async()=>{const s=await rs();N(s)};r.useEffect(()=>{y.length===0&&v()},[y.length]);const O=s=>{const p=Object.keys(s),m=[];return y.forEach(h=>{if(p.includes(h.name)){const D={fieldName:h.name||"",fieldValue:s[h.name]||""};m.push(D)}}),m};r.useEffect(()=>{if(o){const s=U.map(p=>{const m=p;return i==="edit"&&E&&L(p.name,Pe(E,p.name)?E[p.name]:void 0),m});k(s)}},[E,o,i]);const V=()=>{U.forEach(s=>{L(s.name,""),s.isExtraFields&&L(s.name,s.default||"")}),f(),I(!1)},_=async s=>{const{userType:p,userInfo:{companyName:m}}=await Ye({email:s,companyId:e,channelId:Ce}),h=[Q.DOES_NOT_EXIST,Q.B2C,Q.CURRENT_B2B_COMPANY_DIFFERENT_CHANNEL].includes(p);return h||A("email",{type:"custom",message:x(Ke[p],{companyName:m?"(".concat(m,")"):"",email:s})}),{isValid:h,userType:p}},q=()=>{d(async s=>{C(!0);const p=O(s);let m=x("userManagement.addUserSuccessfully");try{const h={companyId:e,companyRoleId:Number(s.companyRoleId),...s,extraFields:p};if(i!=="edit"){const{isValid:D,userType:g}=await _(s.email);if(!D){C(!1);return}g===Q.CURRENT_B2B_COMPANY_DIFFERENT_CHANNEL&&(h.addChannel=!0,m=x("userManagement.userDetected",{email:s.email})),await Qe(h)}i==="edit"&&(h.userId=(E==null?void 0:E.id)||"",m=x("userManagement.updateUserSuccessfully"),delete h.email,await ls(h)),V(),de.success(m),t()}finally{C(!1)}})()},z=async s=>{const{type:p}=s,m=We(p,x,p==="edit"?l===Number(s.userId):!1);if(p==="edit"){const{userId:D}=s,g=await es({userId:D,companyId:e}),T=g.extraFields||[];let a=g;if(T&&T.length>0){const S={};T.forEach($=>{S[$.fieldName]=$.fieldValue}),a={...g,...S}}j({id:D,...a});const b=m.find(S=>S.name==="companyRoleId")||null;b&&(b.defaultName=(g==null?void 0:g.companyRoleName)||"",b.default=(g==null?void 0:g.companyRoleId)||"")}const h=Te(m,y);k(h),F(p),I(!0)};return r.useImperativeHandle(c,()=>({handleOpenAddEditUserClick:z})),n.jsx(ce,{isOpen:o,title:x(i==="edit"?"userManagement.editUser":"userManagement.addNewUser"),leftSizeBtn:x("userManagement.cancel"),rightSizeBtn:x("userManagement.saveUser"),handleLeftClick:V,handRightClick:q,loading:B,isShowBordered:!0,children:n.jsx(Me,{formFields:U,errors:R,control:w,getValues:u,setValue:L})})}const cs=r.forwardRef(is),ie=e=>e!==void 0&&e!==""?Number(e):void 0,ds="\n  mutation DeleteUser ($companyId: Int!, $userId: Int!) { \n    userDelete ( companyId: $companyId, userId: $userId ) {\n      message\n    }\n  }\n",us=e=>P.graphqlB2B({query:ds,variables:{companyId:ie(e.companyId),userId:ie(e.userId)}}),ms="\n  query GetUsers($first: Int!, $offset: Int!, $q: String, $companyId: Int!, $companyRoleId: Decimal) {\n    users (\n      first: $first\n      search: $q\n      offset: $offset\n      companyId: $companyId\n      companyRoleId: $companyRoleId\n    ){\n      totalCount,\n      edges{\n        node{\n          id,\n          firstName,\n          lastName,\n          email,\n          companyRoleName,\n          companyInfo {\n            companyId,\n          },\n        }\n      }\n    }\n  }\n",fs=e=>P.graphqlB2B({query:ms,variables:{...e,q:e.q||"",companyId:Number(e.companyId),companyRoleId:e.companyRoleId!==void 0&&e.companyRoleId!==""?Number(e.companyRoleId):void 0}}),ps=Z("div")(()=>({display:"flex",alignItems:"center",justifyContent:"space-between"}));function ys(e){const{item:t,onEdit:c,onDelete:l}=e,{companyInfo:o,id:I,companyRoleName:i,firstName:F,lastName:E,email:j}=t,{userUpdateActionsPermission:B,userDeleteActionsPermission:C}=ue,U=re({code:B,companyId:Number((o==null?void 0:o.companyId)||0),userId:Number(I)}),k=re({code:C,companyId:Number((o==null?void 0:o.companyId)||0),userId:Number(I)}),y=()=>Je().map(d=>Number(d.value)===2?i!=="Junior Buyer"?{color:"#ce93d8",textColor:"black",...d,label:i,name:i}:{color:"#D9DCE9",textColor:"black",...d}:Number(d.value)===1?{color:"rgba(237, 108, 2, 0.3)",textColor:"black",...d}:{color:"#C4DD6C",textColor:"black",...d}),N=x=>{const d=y().find(u=>u.name===x);return d?n.jsx(Ne,{color:d.color,textColor:d.textColor,children:d.label}):null};return n.jsx(pe,{children:n.jsxs(ye,{sx:{color:"#313440"},children:[n.jsxs(te,{variant:"h5",sx:{color:"rgba(0, 0, 0, 0.87)"},children:[F," ",E]}),n.jsx(te,{sx:{p:"15px 0"},variant:"body1",children:j}),n.jsxs(ps,{children:[N(i),n.jsxs(K,{children:[U&&n.jsx(ae,{"aria-label":"edit",size:"small",sx:{marginRight:"8px"},onClick:()=>c(t.id),children:n.jsx(Le,{fontSize:"inherit"})}),k&&n.jsx(ae,{"aria-label":"delete",size:"small",onClick:()=>l(t.id),children:n.jsx($e,{fontSize:"inherit"})})]})]})]})},I)}function Ms(){const[e,t]=r.useState(!1),[c,l]=r.useState(!1),[o,I]=r.useState(),i=J(),[F]=ee(),E=Be(),j=M(({b2bFeatures:a})=>a.masqueradeCompany.id),B=M(({company:a})=>a.customer.role),C=M(({company:a})=>a.companyInfo),U=Number(B)===Re.SUPER_ADMIN?j:C==null?void 0:C.id,k=M(Ee),{selectCompanyHierarchyId:y}=M(({company:a})=>a.companyHierarchyInfo),N=k.userCreateActionsPermission,x=r.useMemo(()=>{const{userCreateActionsPermission:a}=ue,b=Ue(a,Number(y));return{isEnabled:N&&b,customLabel:i("userManagement.addUser")}},[N,y]),w=r.useRef(null),[d]=ke(),u={first:12,offset:0,search:"",companyRoleId:"",companyId:U,q:""},R=me(i),[f,L]=r.useState(u),[A,v]=r.useState(R),[O,V]=r.useState(""),_=async a=>{const b=await fs(a),{users:{edges:S,totalCount:$}}=b;return{edges:S,totalCount:$}},q=()=>{var a;(a=d.current)==null||a.refresh()},z=()=>{const a=R.map(b=>{var H;const S=b,$=(H=b.options)==null?void 0:H.map(G=>{const fe=G;return fe.label=i(G.idLang),G});return S.options=$,S.setValueName=V,S.default=f.companyRoleId,S.defaultName=f.companyRoleId?O:"",b});return v(a),a},s=(a,b)=>{const S={...f,q:b};L(S)},p=a=>{const b={...f,companyRoleId:a.companyRoleId,offset:0};L(b)},m=()=>{var a;(a=w.current)==null||a.handleOpenAddEditUserClick({type:"add"})},h=a=>{var b;(b=w.current)==null||b.handleOpenAddEditUserClick({type:"edit",userId:a})},D=a=>{I(a),l(!0)},g=()=>{l(!1)},T=async a=>{if(a)try{t(!0),g(),await us({userId:a,companyId:y||U}),de.success(i("userManagement.deleteUserSuccessfully"))}finally{t(!1),q()}};return r.useEffect(()=>{z()},[f,f.companyRoleId]),n.jsx(Se,{isSpinning:e,children:n.jsxs(K,{sx:{display:"flex",flexDirection:"column",flex:1},children:[n.jsx(Fe,{filterMoreInfo:A,handleChange:s,handleFilterChange:p,customButtonConfig:x,handleFilterCustomButtonClick:m}),n.jsx(He,{ref:d,getRequestList:_,searchParams:f||{},itemXs:E?3:4,requestLoading:t,renderItem:a=>n.jsx(ys,{item:a,onEdit:h,onDelete:D},a.id)}),n.jsx(cs,{companyId:"".concat(y||U),renderList:q,ref:w}),n.jsx(ce,{isOpen:c,title:i("userManagement.deleteUser"),leftSizeBtn:i("userManagement.cancel"),rightSizeBtn:i("userManagement.delete"),handleLeftClick:g,handRightClick:T,row:o,rightStyleBtn:{color:"#D32F2F"},isShowBordered:!1,children:n.jsx(K,{sx:{display:"flex",width:F?"100%":"450px",height:"100%"},children:i("userManagement.confirmDelete")})})]})})}export{Ms as default};
//# sourceMappingURL=index-rJ-Egqvb.js.map
