{"version":3,"file":"recaptcha-jSfBfPwt.js","sources":["../../src/components/captcha/frameCaptchaCode.js?raw","../../src/components/captcha/Captcha.tsx","../../src/shared/service/b2b/graphql/recaptcha.ts"],"sourcesContent":["export default \"/* eslint-disable */\\n\\nwindow.INITIALIZE_CAPTCHA_PREFIX = function () {\\n  if (window.grecaptcha?.render === undefined) {\\n    return\\n  }\\n\\n  if (window.WIDGET_TIMER_PREFIX !== null) {\\n    window.clearInterval(window.WIDGET_TIMER_PREFIX)\\n    window.WIDGET_TIMER_PREFIX = null\\n  }\\n\\n  var sendMessage = function (eventType, payload) {\\n    window.parent.postMessage(\\n      'PREFIX' +\\n        JSON.stringify({\\n          type: eventType,\\n          payload: payload,\\n        }),\\n      'PARENT_ORIGIN'\\n    )\\n  }\\n\\n  window.grecaptcha.render(\\n    'PREFIX',\\n    {\\n      callback: function (token) {\\n        sendMessage('CAPTCHA_SUCCESS', token)\\n      },\\n      'error-callback': function () {\\n        sendMessage('CAPTCHA_ERROR', null)\\n      },\\n      'expired-callback': function () {\\n        sendMessage('CAPTCHA_EXPIRED', null)\\n      },\\n    },\\n    true\\n  )\\n}\\n\\nwindow.WIDGET_TIMER_PREFIX = window.setInterval(\\n  window.INITIALIZE_CAPTCHA_PREFIX,\\n  250\\n)\\n\"","import { useEffect, useMemo, useRef } from 'react';\n\nimport { themeFrameSelector, useAppSelector } from '@/store';\n\n// eslint-disable-next-line import/extensions\nimport FRAME_HANDLER_CODE from './frameCaptchaCode.js?raw';\n\nconst CAPTCHA_URL = 'https://www.google.com/recaptcha/api.js?render=explicit';\n\ninterface CaptchaProps {\n  siteKey: string;\n  size?: 'compact' | 'normal';\n  theme?: 'dark' | 'light';\n  handleGetKey: (arg: string) => void;\n}\n\nexport function loadCaptchaScript(iframeDocument: HTMLIFrameElement['contentDocument']) {\n  if (iframeDocument?.head.querySelector(`script[src=\"${CAPTCHA_URL}\"]`) === null) {\n    const captchaScript = iframeDocument.createElement('script');\n    captchaScript.src = CAPTCHA_URL;\n    iframeDocument.head.appendChild(captchaScript);\n  }\n}\n\nexport function loadCaptchaWidgetHandlers(\n  iframeDocument: HTMLIFrameElement['contentDocument'],\n  widgetId: string,\n) {\n  if (!iframeDocument) {\n    return;\n  }\n\n  const handlerScript = iframeDocument.createElement('script');\n\n  const code = FRAME_HANDLER_CODE.replace(/PREFIX/g, widgetId).replace(\n    /PARENT_ORIGIN/g,\n    window.location.origin,\n  );\n\n  handlerScript.textContent = code;\n  iframeDocument.head.appendChild(handlerScript);\n}\n\nconst useWidgetId = () => {\n  return useMemo(() => `widget_${Date.now()}`, []);\n};\n\nexport function Captcha({ theme, size, handleGetKey, siteKey }: CaptchaProps) {\n  const iframeDocument = useAppSelector(themeFrameSelector);\n  const widgetId = useWidgetId();\n  const initialized = useRef(false);\n\n  useEffect(() => {\n    const onMessage = (event: MessageEvent) => {\n      if (event?.data?.startsWith?.(widgetId)) {\n        const message = event.data.slice(widgetId.length);\n        const { payload: key, type } = JSON.parse(message);\n\n        if (type === 'CAPTCHA_SUCCESS' && key) {\n          handleGetKey(key);\n        }\n      }\n    };\n\n    window.addEventListener('message', onMessage, false);\n\n    return () => {\n      if (initialized.current) {\n        window.removeEventListener('message', onMessage);\n      }\n    };\n  }, [widgetId, handleGetKey]);\n\n  useEffect(() => {\n    if (iframeDocument === undefined || initialized.current) {\n      return;\n    }\n\n    loadCaptchaScript(iframeDocument);\n    loadCaptchaWidgetHandlers(iframeDocument, widgetId);\n    initialized.current = true;\n  }, [iframeDocument, widgetId]);\n\n  return <div id={widgetId} data-sitekey={siteKey} data-theme={theme} data-size={size} />;\n}\n","import B3Request from '../../request/b3Fetch';\n\nconst getStorefrontTokenQuery = `query {\n    site {\n        settings {\n            reCaptcha {\n                siteKey\n                isEnabledOnStorefront\n            }\n        }\n    }\n}`;\n\nconst resetPassword = `mutation recaptcha($token: String!, $email: String!) {\n    customer {\n      requestResetPassword(\n        reCaptchaV2: { \n            token: $token\n        },\n        input: {\n          email: $email,\n        }\n      ) {\n        errors {\n          ... on ValidationError {\n            message\n          }\n        }\n      }\n    }\n  }\n`;\n\nexport const requestResetPassword = (token: string, email: string): Promise<void> =>\n  B3Request.graphqlBCProxy({\n    query: resetPassword,\n    variables: { token, email },\n  });\n\ninterface CaptchaConfig {\n  siteKey: string;\n  isEnabledOnStorefront: boolean;\n}\n\nexport const getStorefrontToken = (): Promise<CaptchaConfig | undefined> =>\n  B3Request.graphqlBCProxy({\n    query: getStorefrontTokenQuery,\n  }).then((res) => res?.data?.site?.settings?.reCaptcha);\n"],"names":["FRAME_HANDLER_CODE","CAPTCHA_URL","loadCaptchaScript","iframeDocument","captchaScript","loadCaptchaWidgetHandlers","widgetId","handlerScript","code","useWidgetId","useMemo","Captcha","theme","size","handleGetKey","siteKey","useAppSelector","themeFrameSelector","initialized","useRef","useEffect","onMessage","event","_b","_a","message","key","type","jsx","getStorefrontTokenQuery","resetPassword","requestResetPassword","token","email","B3Request","getStorefrontToken","res","_c"],"mappings":"0IAAA,MAAAA,EAAe,29BCOTC,EAAc,0DASb,SAASC,EAAkBC,EAAsD,CACtF,IAAIA,GAAA,YAAAA,EAAgB,KAAK,cAAc,eAAe,OAAAF,EAAW,UAAU,KAAM,CAC/E,MAAMG,EAAgBD,EAAe,cAAc,QAAQ,EAC3DC,EAAc,IAAMH,EACpBE,EAAe,KAAK,YAAYC,CAAa,CAC/C,CACF,CAEO,SAASC,EACdF,EACAG,EACA,CACA,GAAI,CAACH,EACH,OAGF,MAAMI,EAAgBJ,EAAe,cAAc,QAAQ,EAErDK,EAAOR,EAAmB,QAAQ,UAAWM,CAAQ,EAAE,QAC3D,iBACA,OAAO,SAAS,MAAA,EAGlBC,EAAc,YAAcC,EAC5BL,EAAe,KAAK,YAAYI,CAAa,CAC/C,CAEA,MAAME,EAAc,IACXC,EAAAA,QAAQ,IAAM,UAAU,YAAK,OAAS,EAAE,EAG1C,SAASC,EAAQ,CAAE,MAAAC,EAAO,KAAAC,EAAM,aAAAC,EAAc,QAAAC,GAAyB,CAC5E,MAAMZ,EAAiBa,EAAeC,CAAkB,EAClDX,EAAWG,EAAA,EACXS,EAAcC,EAAAA,OAAO,EAAK,EAEhCC,OAAAA,EAAAA,UAAU,IAAM,CACd,MAAMC,EAAaC,GAAwB,SACzC,IAAIC,GAAAC,EAAAF,GAAA,YAAAA,EAAO,OAAP,YAAAE,EAAa,aAAb,MAAAD,EAAA,KAAAC,EAA0BlB,GAAW,CACvC,MAAMmB,EAAUH,EAAM,KAAK,MAAMhB,EAAS,MAAM,EAC1C,CAAE,QAASoB,EAAK,KAAAC,GAAS,KAAK,MAAMF,CAAO,EAE7CE,IAAS,mBAAqBD,GAChCZ,EAAaY,CAAG,CAEpB,CACF,EAEA,cAAO,iBAAiB,UAAWL,EAAW,EAAK,EAE5C,IAAM,CACPH,EAAY,SACd,OAAO,oBAAoB,UAAWG,CAAS,CAEnD,CACF,EAAG,CAACf,EAAUQ,CAAY,CAAC,EAE3BM,EAAAA,UAAU,IAAM,CACVjB,IAAmB,QAAae,EAAY,UAIhDhB,EAAkBC,CAAc,EAChCE,EAA0BF,EAAgBG,CAAQ,EAClDY,EAAY,QAAU,GACxB,EAAG,CAACf,EAAgBG,CAAQ,CAAC,EAEtBsB,MAAC,OAAI,GAAItB,EAAU,eAAcS,EAAS,aAAYH,EAAO,YAAWC,CAAA,CAAM,CACvF,CClFA,MAAMgB,EAA0B,uKAW1BC,EAAgB,kWAoBTC,EAAuB,CAACC,EAAeC,IAClDC,EAAU,eAAe,CACvB,MAAOJ,EACP,UAAW,CAAE,MAAAE,EAAO,MAAAC,CAAA,CACtB,CAAC,EAOUE,EAAqB,IAChCD,EAAU,eAAe,CACvB,MAAOL,CACT,CAAC,EAAE,KAAMO,GAAA,WAAQ,OAAAC,GAAAd,GAAAC,EAAAY,GAAA,YAAAA,EAAK,OAAL,YAAAZ,EAAW,OAAX,YAAAD,EAAiB,WAAjB,YAAAc,EAA2B,UAAS"}