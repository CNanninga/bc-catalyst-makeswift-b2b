{"version":3,"file":"headless.js","sources":["../src/utils/headlessInitializer.ts","../src/headless.ts"],"sourcesContent":["import { getAPIBaseURL } from '../shared/service/request/base';\nimport { Environment } from '../types';\n\nconst BUYER_PORTAL_INJECTED_SCRIPT_CLASS = `buyer-portal-scripts-headless`;\n\nexport async function initHeadlessScripts() {\n  const parseAndInsertStorefrontScripts = (storefrontScripts: string) => {\n    const b2bScriptDocument = new DOMParser().parseFromString(storefrontScripts, 'text/html');\n    const b2bScriptNodes = b2bScriptDocument.querySelectorAll('script');\n\n    if (b2bScriptNodes.length > 0) {\n      const existingBuyerPortalScriptNodes = document.querySelectorAll(\n        `script.${BUYER_PORTAL_INJECTED_SCRIPT_CLASS}`,\n      );\n      if (existingBuyerPortalScriptNodes.length > 0) {\n        existingBuyerPortalScriptNodes.forEach((oldNode) => {\n          oldNode.parentNode?.removeChild(oldNode);\n        });\n      }\n\n      b2bScriptNodes.forEach((node) => {\n        const scriptElement = document.createElement('script');\n        [...node.attributes].forEach((attr) => {\n          scriptElement.setAttribute(attr.nodeName, attr.nodeValue as string);\n        });\n        scriptElement.innerHTML = node.innerHTML;\n        scriptElement.className = BUYER_PORTAL_INJECTED_SCRIPT_CLASS;\n        document.body.appendChild(scriptElement);\n      });\n    }\n  };\n\n  async function getScriptContent(originUrl: string): Promise<string> {\n    // cSpell:ignore storehash, channelid\n    const headlessScriptNode: HTMLElement | null = document.querySelector(\n      'script[data-storehash][data-channelid]',\n    );\n    const params: {\n      siteUrl: string;\n      storeHash: string;\n      channelId: string;\n      environment?: Environment;\n    } = {\n      siteUrl: originUrl,\n      storeHash: headlessScriptNode?.dataset?.storehash ?? '',\n      channelId: headlessScriptNode?.dataset?.channelid ?? '',\n      environment: headlessScriptNode?.dataset?.environment as Environment,\n    };\n    const response = await fetch(`${getAPIBaseURL(params.environment)}/graphql`, {\n      method: 'POST',\n      headers: {\n        'content-type': 'application/json',\n      },\n      body: JSON.stringify({\n        query: `\n          {\n            storefrontScript(\n              storeHash: \"${params.storeHash}\"\n              channelId: ${params.channelId}\n              siteUrl: \"${params.siteUrl}\"\n            ) {\n              script\n              storeHash\n              channelId\n            }\n          }`,\n      }),\n    });\n\n    if (!response.ok) {\n      throw new Error('network error');\n    }\n\n    const {\n      data: { storefrontScript },\n    } = await response.json();\n    return storefrontScript.script;\n  }\n\n  const scriptContent = await getScriptContent(window.location.origin);\n  parseAndInsertStorefrontScripts(scriptContent);\n}\n","import b2bLogger from './utils/b3Logger';\nimport { initHeadlessScripts } from './utils/headlessInitializer';\n\ninitHeadlessScripts().catch((error: TypeError) => {\n  b2bLogger.error(`unexpected error during headless buyer portal initialization`, error);\n});\n"],"names":["BUYER_PORTAL_INJECTED_SCRIPT_CLASS","initHeadlessScripts","parseAndInsertStorefrontScripts","storefrontScripts","b2bScriptNodes","existingBuyerPortalScriptNodes","oldNode","_a","node","scriptElement","attr","getScriptContent","originUrl","headlessScriptNode","params","_b","_d","_c","_e","response","getAPIBaseURL","storefrontScript","scriptContent","error","b2bLogger"],"mappings":"4KAGA,MAAMA,EAAqC,gCAE3C,eAAsBC,GAAsB,CAC1C,MAAMC,EAAmCC,GAA8B,CAErE,MAAMC,EADoB,IAAI,UAAA,EAAY,gBAAgBD,EAAmB,WAAW,EAC/C,iBAAiB,QAAQ,EAElE,GAAIC,EAAe,OAAS,EAAG,CAC7B,MAAMC,EAAiC,SAAS,iBAC9C,UAAU,OAAAL,EAAkC,EAE1CK,EAA+B,OAAS,GAC1CA,EAA+B,QAASC,GAAY,QAClDC,EAAAD,EAAQ,aAAR,MAAAC,EAAoB,YAAYD,EAClC,CAAC,EAGHF,EAAe,QAASI,GAAS,CAC/B,MAAMC,EAAgB,SAAS,cAAc,QAAQ,EACrD,CAAC,GAAGD,EAAK,UAAU,EAAE,QAASE,GAAS,CACrCD,EAAc,aAAaC,EAAK,SAAUA,EAAK,SAAmB,CACpE,CAAC,EACDD,EAAc,UAAYD,EAAK,UAC/BC,EAAc,UAAYT,EAC1B,SAAS,KAAK,YAAYS,CAAa,CACzC,CAAC,CACH,CACF,EAEA,eAAeE,EAAiBC,EAAoC,eAElE,MAAMC,EAAyC,SAAS,cACtD,wCAAA,EAEIC,EAKF,CACF,QAASF,EACT,WAAWG,GAAAR,EAAAM,GAAA,YAAAA,EAAoB,UAApB,YAAAN,EAA6B,YAA7B,KAAAQ,EAA0C,GACrD,WAAWC,GAAAC,EAAAJ,GAAA,YAAAA,EAAoB,UAApB,YAAAI,EAA6B,YAA7B,KAAAD,EAA0C,GACrD,aAAaE,EAAAL,GAAA,YAAAA,EAAoB,UAApB,YAAAK,EAA6B,WAAA,EAEtCC,EAAW,MAAM,MAAM,GAAG,OAAAC,EAAcN,EAAO,WAAW,EAAC,YAAY,CAC3E,OAAQ,OACR,QAAS,CACP,eAAgB,kBAAA,EAElB,KAAM,KAAK,UAAU,CACnB,MAAO,2EAGa,OAAAA,EAAO,UAAS,gCACjB,OAAAA,EAAO,UAAS,8BACjB,OAAAA,EAAO,QAAO,yHAAA,CAOjC,CAAA,CACF,EAED,GAAI,CAACK,EAAS,GACZ,MAAM,IAAI,MAAM,eAAe,EAGjC,KAAM,CACJ,KAAM,CAAE,iBAAAE,CAAA,CAAiB,EACvB,MAAMF,EAAS,KAAA,EACnB,OAAOE,EAAiB,MAC1B,CAEA,MAAMC,EAAgB,MAAMX,EAAiB,OAAO,SAAS,MAAM,EACnET,EAAgCoB,CAAa,CAC/C,CC9EArB,IAAsB,MAAOsB,GAAqB,CAChDC,EAAU,MAAM,+DAAgED,CAAK,CACvF,CAAC"}