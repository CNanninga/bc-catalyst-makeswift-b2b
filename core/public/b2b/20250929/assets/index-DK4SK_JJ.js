import{j as n,I as cn,s as ln,Y as Z,X as dn,G as ae,B as m,T as N,y as ye,A as ke,ae as Ae,b as Be,ag as De,w as un}from"./mui-DjJKBaL-.js";import{r as u}from"./intl-D34a3Rgg.js";import{f as we}from"./lodashEs-CONzB2I0.js";import{u as O,j as W,a2 as Te,ao as Fe,at as pn,ak as se,a as le,au as re,al as mn,ad as Le,af as de,av as Oe,aw as ee,ax as he,ay as ce,az as xn,a6 as fn,G as yn,am as hn,ah as bn,aA as gn,aB as Se}from"./react-setup-Ctz-bmMs.js";import"./load-functions-utyuqH_X.js";import{b as xe}from"./base-CC7kTJh2.js";import{i as vn,g as Re,f as U,a as Cn,b as In,c as jn,e as wn,d as Sn}from"./payment-DFz-QQyZ.js";import{u as Nn}from"./useSort-57pG6e8y.js";import{B as Pn}from"./B2BAutoCompleteCheckbox-D-VubPB0.js";import{B as kn}from"./B3Filter-lpxTHO2P.js";import{a as ue,u as An}from"./router-DcuTQ_yx.js";import{M as Bn}from"./muiIcon-BBtg8u0V.js";import{r as Dn}from"./resizable--E4yx90G.js";import{g as Tn}from"./reactVendor-CkUTLE5B.js";import{r as Fn}from"./pdfobject-D0FhM6yY.js";import"./eCache-97HTO8co.js";import"./redux-Bt5-tVzx.js";import"./toolkit-CpEbzTSY.js";import"../index.js";import"./global-D7Yn0gGb.js";import"./dropzone-B1UJxEDf.js";import"./dateFns-DubixNBV.js";import"./b3checkout-CprzFgHU.js";import"./B3FilterMore-a9Nafl2O.js";import"./form-pKe_k4Gy.js";import"./B3CustomForm-BLuJSiae.js";import"./B3FilterSearch-BPb2-EyD.js";const Ln=i=>new Promise((o,t)=>{fetch(i).then(l=>l.blob()).then(l=>{const y=new Blob([l],{type:"application/pdf"}),g=window.URL.createObjectURL(y);o(g)}).catch(l=>{t(l)})}),Ee=async(i,o=!1)=>{const{invoicePdf:{url:t}}=await vn(Number(i),o);return t},be=async(i,o=!1)=>{let t="";try{return t=await Ee(i,o),await Ln(t)}catch(l){return t}};function On(i,o){const t=document.createElement("a");t.href=i,t.target="_blank",t.download=o,t.click()}const Rn=ln(dn)(()=>({"& .MuiPaper-elevation":{boxShadow:"0px 1px 0px -1px rgba(0, 0, 0, 0.1), 0px 1px 6px rgba(0, 0, 0, 0.07), 0px 1px 4px rgba(0, 0, 0, 0.06)",borderRadius:"4px"}}));function $e({row:i,setIsRequestLoading:o,setInvoiceId:t,handleOpenHistoryModal:l,isCurrentCompany:y,invoicePay:g}){const h=O(({global:p})=>p.storeInfo.platform),x=u.useRef(null),[B,A]=u.useState(!1),[d,D]=u.useState(!0),I=ue(),j=W(),{invoicePayPermission:C,purchasabilityPermission:R}=O(Te),{getOrderPermission:L}=Fe,[T,E]=u.useState(!1),P=()=>{A(!1)},_=()=>{const{id:p}=i;t(p),A(!0)},z=async p=>{const{id:w}=i;P(),o(!0);const F=await be(w,p);if(o(!1),!F){se.error("pdf url resolution error");return}const{href:k}=window.location;k.includes("invoice")&&window.open(F,"_blank","fullscreen=yes")},M=()=>{const{orderNumber:p}=i;P(),I("/orderDetail/".concat(p))},K=async()=>{P();const{openBalance:p,originalBalance:w,id:F}=i,k={lineItems:[{invoiceId:Number(F),amount:p.value==="."?"0":"".concat(Number(p.value))}],currency:(p==null?void 0:p.code)||w.code};if(p.value==="."||Number(p.value)===0){se.error("The payment amount entered has an invalid value.");return}await Re(k,h,!1)},ne=async()=>{P(),l(!0)},X=async()=>{const{id:p}=i;P(),o(!0);const w=await Ee(p);o(!1),On(w,"file.pdf")};return u.useEffect(()=>{const{openBalance:p,orderUserId:w,companyInfo:F}=i,k=Number(p.value)>0&&C&&R;D(y?k:k&&g);const V=pn({code:L,companyId:Number(F.companyId),userId:Number(w)});E(V)},[]),n.jsxs(n.Fragment,{children:[n.jsx(cn,{onClick:_,ref:x,"aria-label":j("invoice.actions.moreActions"),"aria-haspopup":"menu",children:n.jsx(Bn,{})}),n.jsxs(Rn,{id:"basic-menu",anchorEl:x.current,open:B,onClose:P,MenuListProps:{"aria-labelledby":"basic-button"},anchorOrigin:{vertical:"bottom",horizontal:"right"},transformOrigin:{vertical:"top",horizontal:"right"},children:[n.jsx(Z,{sx:{color:"primary.main"},onClick:()=>z(i.status!==2&&C&&R),children:j("invoice.actions.viewInvoice")},"View-invoice"),T&&n.jsx(Z,{sx:{color:"primary.main"},onClick:M,children:j("invoice.actions.viewOrder")},"View-Order"),i.status!==0&&n.jsx(Z,{sx:{color:"primary.main"},onClick:ne,children:j("invoice.actions.viewPaymentHistory")},"View-payment-history"),d&&n.jsx(Z,{sx:{color:"primary.main"},onClick:K,children:j("invoice.actions.pay")},"Pay"),n.jsx(Z,{sx:{color:"primary.main"},onClick:()=>z(i.status!==2&&C&&R),children:j("invoice.actions.print")},"Print"),n.jsx(Z,{sx:{color:"primary.main"},onClick:()=>X(),children:j("invoice.actions.download")},"Download")]})]})}function En(i){const o=O(({global:j})=>j.storeInfo.platform),t=W(),[l]=le(),[y,g]=u.useState(0),[h,x]=u.useState("$"),B=O(({b2bFeatures:j})=>j.masqueradeCompany.isAgenting),A=l?{alignItems:"flex-start",flexDirection:"column"}:{alignItems:"center"},{selectedPay:d,decimalPlaces:D}=i,I=async()=>{const j=[];let C="SGD";if(d.length>0){if(d.forEach(T=>{const{node:{id:E,openBalance:P,originalBalance:_}}=T,z=U(Number(P.originValue),D)===P.value?Number(P.originValue):Number(P.value);j.push({invoiceId:Number(E),amount:P.value==="."?"0":"".concat(Number(z))}),C=(P==null?void 0:P.code)||_.code}),j.find(T=>T.amount==="."||Number(T.amount)===0)){se.error(t("invoice.footer.invalidNameError"));return}await Re({lineItems:j,currency:C},o,!1)}};return u.useEffect(()=>{if(d.length>0){const j=L=>{let T=0;L.forEach(E=>{const{node:{openBalance:P}}=E;T+=P.value==="."?0:Number(P.value)}),g(U(T,D))},{node:{openBalance:C}}=d[0],R=re(C.code);x(R),j(d)}},[D,d]),n.jsxs(ae,{sx:{position:"fixed",bottom:l&&B?"52px":0,left:0,backgroundColor:"#fff",width:"100%",padding:l?"0 0 1rem 0":"0 40px 1rem 40px",height:l?"8rem":"auto",marginLeft:0,display:"flex",flexWrap:"nowrap",zIndex:"999"},container:!0,spacing:2,children:[n.jsx(ae,{item:!0,sx:{display:l?"none":"block",width:"290px",paddingLeft:"20px"}}),n.jsx(ae,{item:!0,sx:l?{flexBasis:"100%"}:{flexBasis:"690px",flexGrow:1},children:n.jsxs(m,{sx:{width:"100%",pr:"20px",display:"flex",zIndex:"999",justifyContent:"space-between",...A},children:[n.jsx(N,{sx:{color:"#000000",fontSize:"16px",fontWeight:"400"},children:t("invoice.footer.invoiceSelected",{invoices:d.length})}),n.jsxs(m,{sx:{display:"flex",alignItems:"center",flexWrap:l?"wrap":"nowrap",width:l?"100%":"auto"},children:[n.jsx(N,{variant:"h6",sx:{fontSize:"16px",fontWeight:"700",color:"#000000"},children:t("invoice.footer.totalPayment",{total:"".concat(h).concat(y)})}),n.jsx(m,{sx:{display:"flex",alignItems:"center",marginTop:l?"0.5rem":0,width:l?"100%":"auto"},children:n.jsx(ye,{variant:"contained",sx:{marginLeft:l?0:"1rem",width:l?"100%":"auto"},onClick:()=>{I()},children:t("invoice.footer.payInvoices")})})]})]})}),n.jsx(ae,{item:!0,sx:l?{flexBasis:"100%",display:l?"none":"block"}:{flexBasis:"0",display:l?"none":"block"}})]})}function Ve(i){const{code:o}=i,t=W(),y=(g=>({0:{textColor:"#000000",name:t("invoice.filterStatus.open"),color:"#F1C224"},1:{textColor:"#FFFFFF",name:t("invoice.filterStatus.partiallyPaid"),color:"#516FAE"},2:{textColor:"#000000",name:t("invoice.filterStatus.paid"),color:"#C4DD6C"},3:{textColor:"#FFFFFF",name:t("invoice.filterStatus.overdue"),color:"#D32F2F"}})[g]||{})(o);return y.name?n.jsx(mn,{color:y.color,textColor:y.textColor,children:y.name}):null}function oe({title:i}){return n.jsxs(N,{sx:{fontWeight:"bold",pr:"5px"},children:[i,":"]})}function $n({list:i}){return n.jsx(n.Fragment,{children:i.map(o=>{const{node:{createdAt:t,amount:l,paymentType:y,transactionType:g,referenceNumber:h,id:x}}=o;return n.jsx(ke,{sx:{mb:"10px"},children:n.jsxs(Ae,{sx:{color:"#313440",wordBreak:"break-word"},children:[n.jsxs(m,{sx:{display:"flex"},children:[n.jsx(oe,{title:"Date received"}),n.jsx(N,{variant:"body1",children:"".concat(ee(Number(t)))})]}),n.jsxs(m,{sx:{display:"flex"},children:[n.jsx(oe,{title:"Amount"}),n.jsx(N,{variant:"body1",children:he(l.code,Number((l==null?void 0:l.value)||0))})]}),n.jsxs(m,{sx:{display:"flex"},children:[n.jsx(oe,{title:"Transaction type"}),n.jsx(N,{variant:"body1",children:g})]}),n.jsxs(m,{sx:{display:"flex"},children:[n.jsx(oe,{title:"Payment type"}),n.jsx(N,{variant:"body1",children:y})]}),n.jsxs(m,{sx:{display:"flex"},children:[n.jsx(oe,{title:"Reference"}),n.jsx(N,{variant:"body1",children:h||"–"})]})]})},x)})})}function Vn({open:i,setOpen:o,currentInvoiceId:t}){const l=W(),[y]=le(),[g,h]=u.useState(!1),[x,B]=u.useState([]);return u.useEffect(()=>{i&&t&&(async()=>{h(!0);const{allReceiptLines:{edges:d=[]}}=await Cn(Number(t));B(d),h(!1)})()},[i,t]),n.jsx(Le,{isOpen:i,leftSizeBtn:"",rightSizeBtn:"ok",title:l("invoice.paymentHistory.title"),showLeftBtn:!1,handRightClick:()=>o(!1),children:n.jsx(m,{sx:{width:y?"100%":"384px",maxHeight:"600px"},children:n.jsx(de,{isSpinning:g,children:n.jsx(m,{sx:{display:"flex",flexDirection:"column",flex:1},children:x.length?n.jsx($n,{list:x}):n.jsx(Oe,{})})})})})}const G={NORMAL:"normal",DETAIL:"detail",CHECKOUT:"checkout"},Hn=[{key:"open",value:0,label:"Open"},{key:"partialPaid",value:1,label:"Partially paid"},{key:"paid",value:2,label:"Paid"},{key:"overdue",value:3,label:"Overdue"}],zn=[{name:"status",label:"Status",required:!1,default:"",fieldType:"dropdown",xs:12,variant:"filled",size:"small",options:Hn}],Ne={status:"invoice.filterStatus.title",open:"invoice.filterStatus.open",partialPaid:"invoice.filterStatus.partiallyPaid",paid:"invoice.filterStatus.paid",overdue:"invoice.filterStatus.overdue"},He="id",ze={id:"invoiceNumber",orderNumber:"orderNumber",createdAt:"createdAt",updatedAt:"dueDate",originalBalance:"originalBalanceAmount",openBalance:"openBalanceAmount",status:"status"},Pe={invoiceNumber:"invoice_number",orderNumber:"order_number",createdAt:"created_at",dueDate:"due_date",originalBalanceAmount:"original_balance_amount",openBalanceAmount:"open_balance_amount"};function fe({title:i,withColon:o=!0}){return n.jsx(N,{sx:{fontWeight:"bold",pr:"5px"},children:o?"".concat(i,":"):i})}function Mn({isRow:i=!0,type:o="",value:t,label:l,code:y}){const g=()=>{if(o==="time")return ee(Number(t))||"";if(o==="currency"){const h=Number(t||0);return he(y,h)}if(o==="paymentType"){let h="".concat(t).trim();return t&&(h=h.slice(0,1).toUpperCase()+h.slice(1).toLowerCase()),h}return t||"–"};return n.jsxs(m,{sx:{display:"flex",flexDirection:i?"row":"column"},children:[n.jsx(fe,{title:l}),n.jsx(N,{variant:"body1",children:"".concat(g())})]})}function Un({list:i}){var h;const{receiptLineSet:{edges:o=[]},details:t}=i,l=((h=t==null?void 0:t.paymentDetails)==null?void 0:h.comment)||"",y=W(),g=[{key:"paymentId",label:"Payment#",type:"",isRow:!0,idLang:"payment.paymentNumber"},{key:"createdAt",label:"Payment received on",type:"time",isRow:!0,idLang:"payment.paymentReceivedOn"},{key:"transactionType",label:"Transaction type",type:"",isRow:!0,idLang:"payment.transactionType"},{key:"paymentType",label:"Payment type",type:"paymentType",isRow:!0,idLang:"payment.paymentType"},{key:"totalAmount",label:"Payment total",type:"currency",isRow:!0,idLang:"payment.paymentTotal"},{key:"referenceNumber",label:"Reference",type:"",isRow:!0,idLang:"payment.reference"}];return n.jsxs(m,{children:[g.map(x=>n.jsx(Mn,{isRow:!!x.isRow,type:x.type,value:i[x.key],code:(i==null?void 0:i.totalCode)||"SGD",label:y(x.idLang)},x.key)),n.jsxs(m,{sx:{display:"flex",flexDirection:"column",mb:"30px"},children:[n.jsx(fe,{title:y("payment.paymentComment")}),n.jsx(N,{sx:{maxHeight:"50px"},children:l})]}),n.jsxs(m,{sx:{display:"flex",flexDirection:"column"},children:[n.jsx(fe,{title:y("payment.invoicesPaid"),withColon:!1}),n.jsxs(N,{variant:"body1",children:[y("payment.paymentTowardsInvoices")," "]})]}),n.jsxs(m,{children:[n.jsxs(m,{sx:{borderBottom:"1px solid #D9DCE9",padding:"20px 15px",display:"flex",justifyContent:"space-between",fontWeight:500},children:[n.jsx(N,{sx:{fontSize:"14px",fontWeight:"500",color:"#000000"},children:y("payment.invoiceNumber")}),n.jsx(N,{sx:{fontSize:"14px",fontWeight:"500",color:"#000000"},children:y("payment.amountPaid")})]}),o.map(x=>{const{id:B,invoiceNumber:A,amount:{value:d,code:D}}=x.node,I=Number(d||0),j=he(D,I);return n.jsxs(m,{sx:{borderBottom:"1px solid #D9DCE9",padding:"20px 15px",display:"flex",justifyContent:"space-between"},children:[n.jsx(N,{children:A}),n.jsx(N,{children:j})]},B)})]})]})}function Wn({receiptId:i,type:o}){const[t]=le(),[l,y]=u.useState(!1),[g,h]=u.useState(!1),[x,B]=u.useState(null),A=ue(),d=W();u.useEffect(()=>{const j=async()=>{y(!0);const{receipt:C}=await In(Number(i));B(C),h(!0),y(!1)};o===G.CHECKOUT&&i&&j()},[i,o]);const D=()=>{h(!1),A("/invoice")},I=()=>n.jsx(ye,{onClick:D,variant:"text",children:d("payment.okButton")});return n.jsx(Le,{isOpen:g,leftSizeBtn:"",customActions:I,title:d("payment.paymentSuccess"),showLeftBtn:!1,children:n.jsx(m,{sx:{width:t?"100%":"384px",maxHeight:"600px"},children:n.jsx(de,{isSpinning:l,children:n.jsx(m,{sx:{display:"flex",flexDirection:"column",flex:1},children:x?n.jsx(Un,{list:x}):n.jsx(Oe,{})})})})})}var _n=Dn(),qn=Fn();const Gn=Tn(qn),Kn=300;function Xn({row:i}){var B,A;const o=u.useRef(null),t=u.useRef(null),[l,y]=u.useState(!1),[g,h]=u.useState(Kn),x=(d,{size:D})=>{h(D.height)};return u.useEffect(()=>((async()=>{y(!0);const{id:D}=i,I=await be(D);if(!I){se.error("pdf url resolution error");return}o!=null&&o.current&&(Gn.embed(I,o.current),y(!1))})(),()=>{o.current=null}),[i]),n.jsx(de,{isSpinning:l,children:n.jsx(m,{ref:t,sx:{display:"flex",flexWrap:"wrap",width:"100%","& .box":{display:"flex",flexDirection:"column",overflow:"hidden",position:"relative",width:"100%","& .react-resizable":{position:"relative"},"& .react-resizable-handle":{position:"absolute",width:"100%",height:"30px",backgroundRepeat:"no-repeat",backgroundOrigin:"content-box",boxSizing:"border-box"},"& .react-resizable-handle-s":{cursor:"ns-resize",bottom:0}}},children:n.jsx(_n.Resizable,{className:"box",height:g,minConstraints:[((B=t==null?void 0:t.current)==null?void 0:B.offsetWidth)||0,0],width:((A=t.current)==null?void 0:A.offsetWidth)||0,onResize:x,resizeHandles:["s"],children:n.jsx("div",{style:{width:"100%",height:"".concat(g,"px")},children:n.jsx("div",{ref:o,style:{height:"100%",width:"100%"}})})})})})}const Yn=un(m)(()=>({"& > span":{padding:"0 9px 0 0"}}));function Jn(i){const o=new Date().getTime(),{item:t,checkBox:l,handleSetSelectedInvoiceAccount:y,handleViewInvoice:g,setIsRequestLoading:h,setInvoiceId:x,handleOpenHistoryModal:B,selectedPay:A=[],handleGetCorrespondingCurrency:d,addBottom:D,isCurrentCompany:I,invoicePay:j}=i,C=W(),R=ue(),{id:L,status:T,dueDate:E,openBalance:P,companyInfo:_}=t,z=P.code||"USD",M=d(z);let K=t.status;T===0&&o>E*1e3&&(K=3);const ne=[{key:"orderNumber",title:C("invoice.invoiceItemCardHeader.order"),render:()=>n.jsx(m,{role:"button",sx:{color:"#000000",cursor:"pointer",textDecoration:"underline"},onClick:()=>{R("/orderDetail/".concat(t.orderNumber))},children:(t==null?void 0:t.orderNumber)||"-"})},{key:"createdAt",title:C("invoice.invoiceItemCardHeader.invoiceDate"),render:()=>"".concat(t.createdAt?ee(Number(t.createdAt)):"–")},{key:"updatedAt",title:C("invoice.invoiceItemCardHeader.dueDate"),render:()=>{const{dueDate:p,status:w}=t,F=o>p*1e3&&w!==2;return n.jsx(N,{sx:{color:F?"#D32F2F":"rgba(0, 0, 0, 0.87)",fontSize:"14px"},children:"".concat(t.dueDate?ee(Number(t.dueDate)):"–")})}},{key:"originalBalance",title:C("invoice.invoiceItemCardHeader.invoiceTotal"),render:()=>{const{originalBalance:p}=t,w=Number(p.value);return ce(w||0)}},{key:"openBalance",title:C("invoice.invoiceItemCardHeader.amountDue"),render:()=>{const{openBalance:p}=t,w=Number(p.value);return ce(w||0)}},{key:"openBalanceToPay",title:C("invoice.invoiceItemCardHeader.amountToPay"),render:()=>{const{openBalance:p,id:w}=t;let F=p.value,k=!0;if(A.length>0){const $=A.find(V=>{const{node:{id:Y}}=V;return Number(Y)===Number(w)});if($){const{node:{openBalance:V}}=$;k=!1,F=V.value,Number(p.value)===0&&(k=!0)}}return n.jsx(Be,{disabled:k,variant:"filled",value:F,InputProps:{startAdornment:n.jsx(De,{position:"start",sx:{padding:"8px 0",marginTop:"0 !important"},children:M||"$"})},sx:{"& input":{paddingTop:"8px"}},onChange:$=>{var Y;const V=(Y=$.target)==null?void 0:Y.value;y(V,w)},type:"number"})}}],X=u.useId();return n.jsx(ke,{role:"group","aria-labelledby":X,sx:{marginBottom:A.length>0&&D?"5rem":0},children:n.jsxs(Ae,{sx:{color:"rgba(0, 0, 0, 0.6)"},children:[n.jsxs(m,{sx:{display:"flex",alignItems:"center",justifyContent:"space-between"},children:[n.jsxs(m,{sx:{display:"flex",alignItems:"center",mb:"0.5rem"},children:[n.jsx(Yn,{children:l&&l(!!(t!=null&&t.disableCurrentCheckbox))}),n.jsx(N,{variant:"h6",sx:{color:"rgba(0, 0, 0, 0.87)"},children:n.jsx(m,{id:X,role:"button",sx:{color:"#000000",cursor:"pointer",textDecoration:"underline"},onClick:()=>{g(L,T,_.companyId)},children:L||"-"})})]}),n.jsx(m,{sx:{mb:"0.5rem"},children:n.jsx($e,{row:t,setInvoiceId:x,handleOpenHistoryModal:B,setIsRequestLoading:h,isCurrentCompany:I,invoicePay:j})})]}),n.jsx(m,{sx:{mb:"1rem"},children:n.jsx(Ve,{code:K})}),ne.map(p=>n.jsxs(m,{sx:{display:"flex",alignItems:"center",mt:"4px"},children:[n.jsx(N,{sx:{fontWeight:"bold",color:"rgba(0, 0, 0, 0.87)",mr:"5px",whiteSpace:"nowrap"},children:"".concat(p.title,":")}),n.jsx(m,{sx:{color:"black",wordBreak:"break-all"},children:p!=null&&p.render?p.render():t[p.key]})]},p.key))]})})}const Qn={q:"",first:10,offset:0,orderBy:"-".concat(ze[He]),companyIds:[]};function Zn(){const i=O(({company:d})=>d.customer.role),o=O(({b2bFeatures:d})=>d.masqueradeCompany.isAgenting),t=O(({company:d})=>d.companyInfo.id),{selectCompanyHierarchyId:l,isEnabledCompanyHierarchy:y}=O(({company:d})=>d.companyHierarchyInfo),g=O(({b2bFeatures:d})=>d.masqueradeCompany.id),{invoicePayPermission:h,purchasabilityPermission:x}=O(Te),B=i===bn.SUPER_ADMIN&&o?Number(g):Number(t),{invoice:A}=O(({company:d})=>d.pagesSubsidiariesPermission);return{isAgenting:o,selectCompanyHierarchyId:l,isEnabledCompanyHierarchy:y,invoicePayPermission:h,purchasabilityPermission:x,currentCompanyId:B,invoiceSubViewPermission:A}}function Pt(){const i=new Date().getTime(),o=W(),{isAgenting:t,selectCompanyHierarchyId:l,isEnabledCompanyHierarchy:y,invoicePayPermission:g,purchasabilityPermission:h,currentCompanyId:x,invoiceSubViewPermission:B}=Zn(),A=ue(),[d]=le(),D=u.useRef(null),{decimal_places:I=2}=xn(),[j,C]=u.useState(!1),[R,L]=u.useState(!1),[T,E]=u.useState(""),[P,_]=u.useState(""),[z,M]=u.useState(""),[K,ne]=u.useState(0),[X,p]=u.useState(0),[w,F]=u.useState([]),[k,$]=u.useState([]),[V,Y]=u.useState([]),[c,q]=u.useState({}),[Me,Ue]=u.useState(o("invoice.exportCsvText")),[We,pe]=u.useState(!1),[J,ie]=u.useState([]),[ge,_e]=u.useState(g),Q=fn({level:gn.COMPANY_SUBSIDIARIES,code:Fe.invoicePayPermission}),{state:{bcLanguage:qe}}=u.useContext(yn),[Ge,Ke,Xe]=Nn(ze,He,c,q),te=An(),me=e=>Object.keys(e).some(r=>r!=="first"&&r!=="offset"&&r!=="orderBy"&&e[r]),Ye=e=>{if(We){ie(e),pe(!1);return}J.length||ie(e);const r=[...J];e.forEach(s=>{const a=(s==null?void 0:s.node)||s;J.some(f=>f.node.id===a.id)||r.push(s)}),ie(r)},Je=async()=>{try{C(!0);const{invoiceStats:e}=await Sn(c!=null&&c.status?Number(c.status):0,Number(I),(c==null?void 0:c.companyIds)||[]);if(e){const{overDueBalance:r,totalBalance:s}=e;ne(Number(U(Number(s),I))),p(Number(U(Number(r),I)))}}catch(e){xe.error(e)}finally{C(!1)}},Qe=(e,r)=>{e==="search"&&(q({...c,q:r}),pe(!0),M(G.NORMAL))},Ze=e=>{const r=e!=null&&e.startValue?Se(new Date(e==null?void 0:e.startValue).getTime()/1e3):"",s=e!=null&&e.endValue?Se(new Date(e==null?void 0:e.endValue).getTime()/1e3,!0):"",a=(e==null?void 0:e.status)===3?0:e==null?void 0:e.status,b={status:"".concat(a)||"",beginDateAt:r,endDateAt:s,beginDueDateAt:(e==null?void 0:e.status)===0?parseInt("".concat(i/1e3),10):"",endDueDateAt:(e==null?void 0:e.status)===3?parseInt("".concat(i/1e3),10):""};q({...c,...b}),pe(!0),M(G.NORMAL)},en=e=>{var r;if(e.length>0){const s=((r=D.current)==null?void 0:r.getCacheList())||[],b=e.map(f=>s.find(S=>{const{node:H}=S;return Number(H.id)===Number(f)})).filter(f=>f&&!f.node.disableCurrentCheckbox);F([...b])}else F([])},ve=async(e,r,s)=>{try{const a=Number(s)===Number(x)?g:Q;C(!0);const f=await be(e,h&&a&&r!==2);if(!f){se.error(o("invoice.pdfUrlResolutionError"));return}const{href:v}=window.location;if(!v.includes("invoice"))return;window.open(f,"_blank","fullscreen=yes")}catch(a){xe.error(a)}finally{C(!1)}},nn=(e,r)=>{const s=w.find(a=>{const{node:{id:b}}=a;return Number(b)===Number(r)});if(k.length>0){const a=k.map(b=>{const{node:{id:f,openBalance:v}}=b,{node:{openBalance:S}}=s;return Number(f)===Number(r)&&(v.value=Number(S.value)<Number(e)?S.value:e),b});$(a)}},tn=async()=>{try{C(!0);const s=((c?me(c):!1)?J.filter(S=>w.some(H=>{var Ie,je;return((Ie=S==null?void 0:S.node)==null?void 0:Ie.id)===((je=H==null?void 0:H.node)==null?void 0:je.id)})):w).map(S=>S.node.id),a=c!=null&&c.status?[Number(c.status)]:[];let b="-invoice_number";if(c!=null&&c.orderBy){const S=String(c.orderBy);b=S.includes("-")?"-".concat(Pe[S.split("-")[1]]):Pe[S]}const f={search:(c==null?void 0:c.q)||"",idIn:"".concat(s||""),orderNumber:"",beginDateAt:(c==null?void 0:c.beginDateAt)||null,endDateAt:(c==null?void 0:c.endDateAt)||null,status:a,orderBy:b,companyIds:(c==null?void 0:c.companyIds)||[]},{invoicesExport:v}=await wn({invoiceFilterData:f,lang:qe||"en"});v!=null&&v.url&&window.open(v==null?void 0:v.url,"_blank")}catch(e){xe.error(e)}finally{C(!1)}};u.useEffect(()=>{const e={...Qn,companyIds:[Number(l)||Number(x)]};if(te!=null&&te.search){const r=new URLSearchParams(te.search),s=r.get("invoiceId")||"",a=r.get("receiptId")||"";s&&(q({...e,q:s}),M(G.DETAIL)),a&&(M(G.CHECKOUT),q({...e}),_(a))}else M(G.NORMAL),q({...e})},[te,l]);const on=e=>{const r=e.includes(-1)?[]:e;q({...c,companyIds:r}),_e(e.includes(x)||e.includes(-1)?g:Q)};u.useEffect(()=>{const e=w.filter(r=>{const{node:{openBalance:s}}=r;return Number(s.value)!==0})||[];if(e.length>0)if(k.length===0)$(we(e));else{const r=e.map(s=>{const{node:{id:a,openBalance:b}}=s,f=k.find(v=>{const{node:{id:S}}=v;return Number(a)===Number(S)});if(f){const{node:{openBalance:v}}=f;b.value=v.value}return s});$(we(r))}else $([])},[w]);const rn=async e=>{const{invoices:{edges:r,totalCount:s}}=await jn(e),a=r;return z===G.DETAIL&&a.length&&a.forEach(b=>{const f=b;f.node.isCollapse=!0}),a.forEach(b=>{const{node:{openBalance:f}}=b,v=b;v.node.disableCurrentCheckbox=!1,f.originValue="".concat(Number(f.value)),f.value=U(Number(f.value),I),v.node.disableCurrentCheckbox=Number(f.value)===0;const{companyInfo:S}=v.node;Number(S.companyId)!==Number(x)&&(v.node.disableCurrentCheckbox=!Q||Number(f.value)===0)}),Y(a),Je(),c&&me(c)&&a.length?Ye(a):ie([]),{edges:a,totalCount:s}},Ce=(e,r)=>{let s=e;if(e.includes(".")){const a=e.split("."),b=I===0?0:a[1].length-Number(I);if(a[1]&&b>0){const f=a[0]+a[1];s="".concat(f.slice(0,-I),".").concat(f.slice(-I))}a[1]&&b===0&&(s=U(Number(e),I))}else s.length>1?(s="".concat(e.slice(0,1),".").concat(e.slice(-1)),Number(I)===0&&(s=e)):s=e;nn(s,r)},sn=[{key:"id",title:o("invoice.headers.invoice"),isSortable:!0,render:e=>n.jsx(m,{sx:{color:"#000000",cursor:"pointer",":hover":{textDecoration:"underline"}},role:"button",onClick:()=>{const r=(e==null?void 0:e.companyInfo)||{};ve(e.id,e.status,r==null?void 0:r.companyId)},children:e!=null&&e.invoiceNumber?e==null?void 0:e.invoiceNumber:e==null?void 0:e.id}),width:"8%"},{key:"companyInfo",title:o("invoice.headers.companyName"),isSortable:!1,render:e=>{const{companyName:r}=(e==null?void 0:e.companyInfo)||{};return n.jsx(m,{children:r})},width:"15%"},{key:"orderNumber",title:o("invoice.headers.order"),isSortable:!0,render:e=>n.jsx(m,{role:"button",sx:{color:"#000000",cursor:"pointer",":hover":{textDecoration:"underline"}},onClick:()=>{A("/orderDetail/".concat(e.orderNumber))},children:(e==null?void 0:e.orderNumber)||"-"}),width:"12%"},{key:"createdAt",title:o("invoice.headers.invoiceDate"),isSortable:!0,render:e=>"".concat(e.createdAt?ee(Number(e.createdAt)):"–"),width:"15%"},{key:"updatedAt",title:o("invoice.headers.dueDate"),isSortable:!0,render:e=>{const{dueDate:r,status:s}=e,a=i>r*1e3&&s!==2;return n.jsx(N,{sx:{color:a?"#D32F2F":"rgba(0, 0, 0, 0.87)",fontSize:"14px"},children:"".concat(e.dueDate?ee(Number(e.dueDate)):"–")})},width:"15%"},{key:"originalBalance",title:o("invoice.headers.invoiceTotal"),isSortable:!0,render:e=>{const{originalBalance:r}=e,s=U(Number(r.value),I),a=re(r.code);return"".concat(a).concat(s||0)},width:"10%"},{key:"openBalance",title:o("invoice.headers.amountDue"),isSortable:!0,render:e=>{const{openBalance:r}=e,s=U(Number(r.value),I),a=re(r.code);return"".concat(a).concat(s||0)},width:"10%"},{key:"openBalanceToPay",title:o("invoice.headers.amountToPay"),render:e=>{const{openBalance:r,id:s}=e,a=r.code||"USD";let b=r.value,f=!0;if(k.length>0){const v=k.find(S=>{const{node:{id:H}}=S;return Number(H)===Number(s)});if(v){const{node:{openBalance:S}}=v;f=!1,b=S.value,Number(r.value)===0&&(f=!0)}}return n.jsx(Be,{disabled:f,variant:"filled",value:b||"",InputProps:{startAdornment:n.jsx(De,{position:"start",sx:{padding:"8px 0",marginTop:"0 !important"},children:re(a)})},sx:{"& input":{paddingTop:"8px"},'& input[type="number"]::-webkit-inner-spin-button, & input[type="number"]::-webkit-outer-spin-button':{WebkitAppearance:"none",margin:0}},onChange:v=>{var H;const S=(H=v.target)==null?void 0:H.value;Ce(S,s)},type:"number"})},width:"15%"},{key:"status",title:o("invoice.headers.status"),isSortable:!0,render:e=>{const{status:r,dueDate:s}=e;let a=e.status;return r===0&&i>s*1e3&&(a=3),n.jsx(Ve,{code:a})}},{key:"invoiceActions",title:o("invoice.headers.action"),render:e=>{const{id:r,companyInfo:s}=e;let a=e;if(k.length>0){const b=k.find(f=>{const{node:{id:v}}=f;return Number(v)===Number(r)});b&&(a=b.node)}return n.jsx($e,{row:a,setInvoiceId:E,handleOpenHistoryModal:L,setIsRequestLoading:C,isCurrentCompany:Number(x)===Number(s.companyId),invoicePay:Number(x)===Number(s.companyId)?g:Q})},width:"10%"}];u.useEffect(()=>{let e=o("invoice.exportCsvText");const r=c?me(c):!1,s=r?J.filter(a=>w.some(b=>{var f,v;return((f=a==null?void 0:a.node)==null?void 0:f.id)===((v=b==null?void 0:b.node)==null?void 0:v.id)})):w;r?e=s.length>0?o("invoice.exportSelectedAsCsv"):o("invoice.exportFilteredAsCsv"):e=s.length>0?o("invoice.exportSelectedAsCsv"):o("invoice.exportCsvText"),Ue(e)},[w,c,J]);const an=zn.map(e=>{const r=e;return e.name==="status"&&(r.label=o(Ne.status)),r.options=e.options.map(s=>{const a=s;return a.label=o(Ne[s.key]),s}),e});return n.jsxs(de,{isSpinning:j,children:[n.jsxs(m,{sx:{overflowX:"auto",display:"flex",flexDirection:"column",flex:1,position:"relative"},children:[n.jsxs(m,{sx:{display:"flex",justifyContent:"space-between",alignItems:d?"flex-start":"center",flexDirection:d?"column":"row"},children:[n.jsxs(m,{sx:{display:"flex",justifyContent:"space-between",alignItems:d?"flex-start":"center",flexDirection:d?"column":"row",width:d?"100%":"auto","& > div":{width:d?"100%":"auto"}},children:[y&&B&&n.jsx(m,{sx:{mr:d?0:"10px",mb:"30px"},children:n.jsx(Pn,{handleChangeCompanyIds:on})}),n.jsx(kn,{filterMoreInfo:an,handleChange:Qe,handleFilterChange:Ze,startPicker:{isEnabled:!0,label:o("invoice.filter.from"),defaultValue:typeof(c==null?void 0:c.beginDateAt)=="number"?Number(c.beginDateAt)*1e3:"",pickerKey:"start"},endPicker:{isEnabled:!0,label:o("invoice.filter.to"),defaultValue:typeof(c==null?void 0:c.endDateAt)=="number"?Number(c.endDateAt)*1e3:"",pickerKey:"end"},searchValue:(c==null?void 0:c.q)||"",pcContainerWidth:"36rem",pcSearchContainerWidth:"80%"})]}),n.jsxs(m,{sx:{display:"flex",marginBottom:"30px",flexDirection:document.body.clientWidth<=465?"column":"row"},children:[n.jsx(N,{sx:{fontSize:"24px",color:"#000000"},children:o("invoice.openUnpaid",{unpaid:ce(K)})}),document.body.clientWidth>=465&&n.jsx(N,{sx:{fontSize:"24px",margin:"0 8px"},children:"|"}),n.jsx(N,{sx:{fontSize:"24px",color:"#D32F2F"},children:o("invoice.overdueAmount",{overdue:ce(X)})})]})]}),n.jsx(hn,{ref:D,columnItems:sn,rowsPerPageOptions:[10,20,30],getRequestList:rn,searchParams:c,isCustomRender:!1,requestLoading:C,tableKey:"id",showCheckbox:ge&&h,showSelectAllCheckbox:!d&&ge&&h,disableCheckbox:!1,applyAllDisableCheckbox:!1,getSelectCheckbox:en,CollapseComponent:Xn,sortDirection:Ke,orderBy:Xe,sortByFn:Ge,isSelectOtherPageCheckbox:!0,hover:!0,isAutoRefresh:!1,renderItem:(e,r,s)=>n.jsx(Jn,{item:e,checkBox:s,handleSetSelectedInvoiceAccount:Ce,handleViewInvoice:ve,setIsRequestLoading:C,setInvoiceId:E,handleOpenHistoryModal:L,selectedPay:k,handleGetCorrespondingCurrency:re,addBottom:V.length-1===r,isCurrentCompany:Number(x)===Number(e.companyInfo.companyId),invoicePay:Number(x)===Number(e.companyInfo.companyId)?g:Q})}),V.length>0&&!d&&n.jsx(m,{sx:{position:"absolute",bottom:"8px",left:"20px"},children:n.jsx(ye,{variant:"text",onClick:tn,children:Me})})]}),k.length>0&&((g||Q)&&h||t)&&n.jsx(En,{selectedPay:k,decimalPlaces:I}),n.jsx(Vn,{open:R,currentInvoiceId:T,setOpen:L}),n.jsx(Wn,{receiptId:Number(P),type:z})]})}export{Pt as default};
//# sourceMappingURL=index-DK4SK_JJ.js.map
