import{j as n,B as G,G as jt,T as gt,w as yt,ah as Qt,b as At,ag as Dt}from"./mui-DjJKBaL-.js";import{r as o}from"./intl-D34a3Rgg.js";import{u as Tt}from"./form-pKe_k4Gy.js";import{j as bt,u as N,c4 as Rt,c8 as _t,af as xt,ag as mt,bo as Wt,ak as nt,aO as Mt,bD as zt,c9 as Kt,bp as Gt,bq as Ut,ad as Vt,aN as Ht,ay as Jt,ba as Et,br as Yt,bm as vt,bs as Xt,a as Ft,aS as Zt,bb as te}from"./react-setup-Bynf4djQ.js";import{B as Nt}from"./B3CustomForm-CTyEaR6B.js";import"./load-functions-BXOIym8k.js";import{u as Bt}from"./useBlockPendingAccountViewPrice-e72KsFSh.js";import{b as ee}from"./base-CC7kTJh2.js";import{g as ne}from"./lodashEs-CONzB2I0.js";import{S as se}from"./ShoppingListDetailsContext-BrHzImtq.js";import{k as $t}from"./muiIcon-BBtg8u0V.js";function Le(v){const d=bt(),{updateList:R,quickAddToList:W,level:e=3,buttonText:L=d("shoppingList.quickAdd.addToShoppingList"),buttonLoading:B=!1,type:A}=v,j=N(({company:i})=>i.companyInfo.status),Y=N(({quoteInfo:i})=>i.draftQuoteList),[q]=Bt(),[O,I]=o.useState(e),[X,$]=o.useState([]),[M,U]=o.useState(!1),x=(i,l)=>{new Array(i).fill(1).forEach((u,c)=>l(c))};o.useEffect(()=>{let i=[];x(O,l=>{i=[...i,...Wt(l,d)]}),$(i)},[O]);const _=()=>{I(O+e)},{control:m,handleSubmit:z,getValues:S,formState:{errors:y},setError:P,setValue:D}=Tt({mode:"all"}),ct=(i,l,u)=>{if(!l&&!u)return!0;let c=!0;const b=parseInt(u,10)||0;return l||(P("sku-".concat(i),{type:"manual",message:d("global.validate.required",{label:d("purchasedProducts.quickAdd.sku")})}),c=!1),u?b<=0&&(P("qty-".concat(i),{type:"manual",message:"incorrect number"}),c=!1):(P("qty-".concat(i),{type:"manual",message:d("global.validate.required",{label:d("purchasedProducts.quickAdd.qty")})}),c=!1),c},ot=i=>{const l={};let u=!0;return x(O,c=>{const b=i["sku-".concat(c)],s=i["qty-".concat(c)];if(u=ct(c,b,s)===!1?!1:u,u&&b){const g=parseInt(s,10)||0;l[b]=l[b]?l[b]+g:g}}),{skuValue:l,isValid:u,skus:Object.keys(l)}},at=o.useCallback((i,l,u)=>{const c=[],b=[],s=[],g=[],T=[],Q=[];return u.forEach(V=>{const H=(i||[]).find(f=>f.variantSku.toUpperCase()===V.toUpperCase());if(!H){c.push(V);return}const{productId:ut,variantId:Lt,option:It,purchasingDisabled:Ct="1",modifiers:Ot,variantSku:kt}=H,pt=Rt(Ot),rt=l[V]||0;if(Ct==="1"&&A!=="shoppingList"){b.push(V);return}if(pt.filter(f=>!f.isVerified).length>0){T.push(V);return}if(Number(rt)<1||Number(rt)>1e6){Q.push(V);return}const w=(It||[]).reduce((f,E)=>{try{const et=typeof E=="string"?JSON.parse(E):E;return f.push({optionId:"attribute[".concat(et.option_id,"]"),optionValue:"".concat(et.id)}),f}catch(et){return f}},[]);pt.forEach(f=>{const{type:E}=f;if(E==="date"){const{defaultValue:et}=f;Object.keys(et).forEach(St=>{w.push({optionId:"attribute[".concat(f.option_id,"][").concat(St,"]"),optionValue:"".concat(f.defaultValue[St])})})}else w.push({optionId:"attribute[".concat(f.option_id,"]"),optionValue:"".concat(f.defaultValue)})}),g.push(V);const it=Y.find(f=>f.node.variantSku===kt);if(it){const f=JSON.parse(it.node.optionList);let{quantity:E}=it.node;if((f.length>w.length?_t(f,w):_t(w,f))&&(E+=rt),E>1e6){Q.push(V);return}}s.push({...H,newSelectOptionList:w,productId:parseInt(ut,10)||0,quantity:rt,variantId:parseInt(Lt,10)||0})}),{notFoundSku:c,notPurchaseSku:b,productItems:s,passSku:g,notAddAble:T,numberLimit:Q}},[Y,A]),K=(i,l,u,c)=>{l.forEach(b=>{const s=Object.keys(i).find(g=>i[g]===b)||"";s&&P(s.replace("sku",u),{type:"manual",message:c})})},Z=(i,l)=>{l.forEach(u=>{const c=Object.keys(i).find(b=>i[b]===u)||"";c&&(D(c,""),D(c.replace("sku","qty"),""))})},lt=async i=>{try{const{variantSku:l}=await Mt(i);return l}catch(l){return[]}},tt=()=>{if(q&&j===0){nt.info("Your business account is pending approval. This feature is currently disabled.");return}z(async i=>{try{U(!0);const{skuValue:l,isValid:u,skus:c}=ot(i);if(!u||c.length<=0)return;const b=await lt(c),{notFoundSku:s,notPurchaseSku:g,productItems:T,notAddAble:Q,passSku:V,numberLimit:H}=at(b,l,c);s.length>0&&(K(i,s,"sku",""),nt.error(d("shoppingList.quickAdd.skuNotFound",{notFoundSku:s.join(", ")}))),g.length>0&&(K(i,g,"sku",""),nt.error(d("shoppingList.quickAdd.skuNotPurchasable",{notPurchaseSku:g.join(", ")}))),Q.length>0&&(K(i,Q,"sku",""),nt.error(d("shoppingList.quickAdd.skuNotAddable",{notAddAble:Q.join(", ")}))),H.length>0&&(H.forEach(ut=>{K(i,[ut],"qty","")}),nt.error(d("shoppingList.quickAdd.skuLimitQuantity",{numberLimit:H.join(", ")}))),T.length>0&&(await W(T),Z(i,V),R())}finally{U(!1)}})()},dt=i=>{i.key==="Enter"&&tt()};return n.jsx(xt,{isSpinning:M,spinningHeight:"auto",children:n.jsxs(G,{sx:{width:"100%"},children:[n.jsxs(jt,{container:!0,sx:{margin:"16px 0"},children:[n.jsx(jt,{item:!0,sx:{flex:1,display:"flex",alignItems:"center"},children:n.jsx(gt,{sx:{color:"#000"},variant:"body1",children:d("shoppingList.quickAdd.quickAdd")})}),n.jsx(jt,{item:!0,children:n.jsx(mt,{variant:"text",sx:{textTransform:"initial",ml:"-8px",fontWeight:"400"},onClick:_,children:d("shoppingList.quickAdd.showMoreRows")})})]}),n.jsx(G,{onKeyDown:dt,sx:{"& label":{zIndex:0}},children:n.jsx(Nt,{formFields:X,errors:y,control:m,getValues:S,setValue:D})}),n.jsx(mt,{variant:"outlined",fullWidth:!0,disabled:M,onClick:tt,sx:{margin:"20px 0"},children:n.jsx(xt,{isSpinning:B?M:!1,tip:"",size:16,children:n.jsx(G,{sx:{flex:1,textAlign:"center"},children:L})})})]})})}const ie=yt("div")({display:"flex",wordBreak:"break-word",gap:"8px",flexWrap:"wrap",padding:"12px 0 12px","&:first-of-type":{marginTop:"12px"}}),wt=yt("div")(({padding:v})=>({display:"flex",flexGrow:1,flexShrink:1,alignItems:"flex-start",width:"100%",padding:v||"0 0 0 16px"})),oe=yt("img")(()=>({width:"60px",height:"60px",borderRadius:"4px",marginTop:"12px",flexShrink:0})),ae=yt("div")(()=>({fontSize:"0.75rem",lineHeight:"1.5",color:"#455A64"})),re=yt(At)(()=>({"& input::-webkit-outer-spin-button, input::-webkit-inner-spin-button":{marginTop:"-8px",marginBottom:"8px"}}));function ce(v){const{isOpen:d,onCancel:R,onConfirm:W,product:e,isEdit:L=!1,isLoading:B,setIsLoading:A,type:j,...Y}=v,q=bt(),{addButtonText:O=q("shoppingList.chooseOptionsDialog.addToList")}=Y,I=N(({global:t})=>t.showInclusiveTaxPrice),X=N(({global:t})=>t.blockPendingQuoteNonPurchasableOOS.isEnableProduct),$=N(({b2bFeatures:t})=>t.masqueradeCompany.id),M=N(t=>t.company.customer.customerGroupId),U=N(t=>t.company.companyInfo.id),[x,_]=o.useState(1),[m,z]=o.useState([]),[S,y]=o.useState(null),[P,D]=o.useState(""),[ct,ot]=o.useState((e==null?void 0:e.imageUrl)||""),[at,K]=o.useState(!0),[Z,lt]=o.useState({}),[tt,dt]=o.useState([]),[i,l]=o.useState(0),[u,c]=o.useState([]),[b,s]=o.useState(!1);o.useEffect(()=>{if(j==="quote"&&e)if(P){const t=e;t.quantity=x;const a=!!zt(t.base_price,t,{sku:P});K(a)}else{const t=e;t.quantity=x,!!Kt(t.base_price,t)||K(!1)}else(j==="shoppingList"||j==="quickOrder")&&e&&K(!(e!=null&&e.isPriceHidden))},[P,x,e,j]);const g=async t=>{var a,p;try{A(!0);const r=((a=t==null?void 0:t.modifiers)==null?void 0:a.filter(C=>C.type==="product_list_with_images"||C.type==="product_list"))||[],k={},F={};if(r.length>0){const C=r.reduce((ht,ft)=>{const{option_values:J}=ft;return J.forEach(Pt=>{var qt;(qt=Pt==null?void 0:Pt.value_data)!=null&&qt.product_id&&ht.push(Pt.value_data.product_id)}),ht},[]);if(C.length>0){const ht=U||$,{productsSearch:ft}=await Et({productIds:C,companyId:ht,customerGroupId:M});ft.forEach(J=>{k[J.id]=J.imageUrl,F[J.id]=J})}}lt(F),_(t.quantity),((p=t.variants)==null?void 0:p.length)===1&&t.variants[0]&&y(t.variants[0]);const h=Yt(t,k);z([...h])}finally{A(!1)}},T=t=>{var p;const a=[];(p=t.allOptions)==null||p.forEach(r=>{(r.type==="product_list_with_images"||r.type==="product_list"||r.type==="checkbox"||r.type==="rectangles"||r.type==="swatch"||r.type==="radio_buttons"||r.type==="dropdown")&&a.push(r)}),dt(a)};o.useEffect(()=>{var t;e?(g(e),c([]),l(0),(t=e==null?void 0:e.allOptions)!=null&&t.length&&T(e)):(_(1),z([]))},[e]);const Q=t=>{var r,k,F;const{variants:a=[]}=t;let p=0;if(P){const h=(r=a.find(C=>C.sku===P))==null?void 0:r.bc_calculated_price;p=(I?h==null?void 0:h.tax_inclusive:h==null?void 0:h.tax_exclusive)||0}else{const h=(k=a[0])==null?void 0:k.bc_calculated_price;p=parseFloat((F=I?h==null?void 0:h.tax_inclusive:h==null?void 0:h.tax_exclusive)==null?void 0:F.toString())||0}return p},V=t=>{(!t.target.value||parseInt(t.target.value,10)>0)&&_(t.target.value)},H=t=>{["KeyE","Equal","Minus"].indexOf(t.code)>-1&&t.preventDefault()},ut=()=>{x||_(1),Number(x)>1e6&&_(1e6)},{control:Lt,handleSubmit:It,getValues:Ct,formState:{errors:Ot},watch:kt,setValue:pt,reset:rt}=Tt({mode:"all"}),st=kt(),w=o.useRef(st),it=o.useCallback(async(t,a="")=>{var F;if(!(((F=m.find(h=>h.name===a))==null?void 0:F.isVariantOption)||!1)||!e||!a)return;const{variants:r=[]}=e||{},k=r.find(h=>{const{option_values:C=[]}=h;return C.reduce((ft,J)=>t[Gt.encode("attribute[".concat(J.option_id,"]"))].toString()!==(J.id||"").toString()?!1:ft,!0)})||null;if(D(k?k.sku:""),y(k),k&&(k.sku||k.variant_id)){const h=r.find(C=>C.sku===k.sku||C.variant_id===k.variant_id);ot((h==null?void 0:h.image_url)||e.imageUrl||"")}},[m,e]);o.useEffect(()=>{const t=kt((a,{name:p})=>{it(a,p)});if(m[0]){const a=m.reduce((p,r)=>{const k=p;return k[r.name]=r.default,pt(r.name,r.default),p},{});it(a,m[0].name)}return()=>t.unsubscribe()},[m,it]);const f=o.useCallback(()=>{const{purchasing_disabled:t=!0}=S||{};return j!=="shoppingList"&&t===!0&&!X?(nt.error(q("shoppingList.chooseOptionsDialog.productNoLongerForSale")),!1):!0},[X,j,S]),E=o.useCallback(t=>{const a=Ut(m,{},t);return Object.keys(a).map(p=>{var r;return{optionId:p,optionValue:(r=a[p])==null?void 0:r.toString()}})},[m]);o.useEffect(()=>{if(!(w!=null&&w.current&&ne(w==null?void 0:w.current,st))&&(w.current=st,Object.keys(st).length&&m.length&&tt.length)){const t=E(st),{variant_id:a=""}=S||{};if(!e||!e.id||!a||!f())return;const p=[{...e,newSelectOptionList:t,productId:e==null?void 0:e.id,quantity:parseInt(x.toString(),10)||1,variantId:parseInt(a.toString(),10)||1,additionalProducts:Z}];if(u[0]){let r=!1;const{newSelectOptionList:k}=u[0];k.forEach(F=>{const h=tt.findIndex(C=>F.optionId.includes(String(C.id)));t.forEach(C=>{F.optionId===C.optionId&&F.optionValue!==C.optionValue&&h!==-1&&(r=!0)})}),r&&c(p)}else c(p)}},[Z,u,m.length,st,E,e,tt,x,f,S]),o.useEffect(()=>{(async()=>{try{if(u.length){s(!0);const a=await vt(u);if(a[0]){const{basePrice:p,taxPrice:r}=a[0],k=Xt(Number(p),Number(r));l(k)}}}catch(a){ee.error(a)}finally{s(!1)}})()},[u]);const et=()=>{It(t=>{const a=E(t),{variant_id:p=""}=S||{};!e||!e.id||!p||!f()||W([{...e,newSelectOptionList:a,productId:e==null?void 0:e.id,quantity:parseInt(x.toString(),10)||1,variantId:parseInt(p.toString(),10)||1,additionalProducts:Z}])})()},St=()=>{_(1),R()};return o.useEffect(()=>{d||rt()},[d]),n.jsx(Vt,{isOpen:d,rightSizeBtn:L?q("shoppingList.chooseOptionsDialog.saveOption"):O,handleLeftClick:St,handRightClick:et,title:q("shoppingList.chooseOptionsDialog.chooseOptions"),loading:B||b,children:n.jsx(xt,{isSpinning:B,children:e&&n.jsx(G,{children:n.jsxs(G,{sx:{display:"flex",flexDirection:"column"},children:[n.jsxs(G,{sx:{display:"flex"},children:[n.jsx(oe,{src:ct||e.imageUrl||Ht}),n.jsxs(ie,{children:[n.jsx(wt,{padding:"0",children:n.jsxs(G,{sx:{marginLeft:"16px"},children:[n.jsx(gt,{variant:"body1",color:"#212121",children:e.name}),n.jsx(gt,{variant:"body1",color:"#616161",children:P||e.sku}),(e.product_options||[]).map(t=>n.jsx(ae,{children:"".concat(t.display_name,": ").concat(t.display_value)},"".concat(t.option_id)))]})}),n.jsxs(wt,{children:[n.jsx("span",{children:q("shoppingList.chooseOptionsDialog.price")}),at?Jt(i*Number(x)||Q(e)):""]}),n.jsx(wt,{children:n.jsx(re,{type:"number",variant:"filled",label:q("shoppingList.chooseOptionsDialog.quantity"),value:x,onChange:V,onKeyDown:H,onBlur:ut,size:"small",sx:{width:"60%",maxWidth:"100px"}})})]})]}),n.jsx(Qt,{sx:{margin:"16px 0 24px"}}),n.jsx(Nt,{formFields:m,errors:Ot,control:Lt,getValues:Ct,setValue:pt})]})})})})}function le(v){const{product:{id:d,allOptions:R},onAddToListClick:W,onChooseOptionsClick:e,addButtonText:L}=v,{state:{isLoading:B=!1}}=o.useContext(se),[A]=Ft(),j=bt();return R&&R.length>0?n.jsx(mt,{variant:"outlined",onClick:()=>{e(d)},disabled:B,fullWidth:A,children:j("global.searchProduct.chooseOptionsButton")}):n.jsx(mt,{variant:"outlined",onClick:()=>{W(d)},disabled:B,fullWidth:A,children:L})}const de=Zt;function ue(v){const d=bt(),{isOpen:R,onCancel:W,searchText:e,productList:L,onSearchTextChange:B,onSearch:A,onProductQuantityChange:j,onAddToListClick:Y,onChooseOptionsClick:q,isLoading:O,type:I,searchDialogTitle:X=d("shoppingLists.title"),addButtonText:$=d("shoppingLists.addButtonText")}=v,M=N(({global:S})=>S.blockPendingQuoteNonPurchasableOOS.isEnableProduct),[U]=Ft(),x=()=>{W()},_=S=>{S.key==="Enter"&&A()},m=o.useCallback(S=>{const{variants:y=[]}=S||{},{purchasing_disabled:P=!0}=y[0]||{};return I!=="shoppingList"&&P===!0&&!M?(nt.error(d("shoppingList.chooseOptionsDialog.productNoLongerForSale")),!1):!0},[M,I]),z=S=>{var P;const y=L.find(D=>D.id===S);if(y&&m(y||{})){let D=y.variantId||0;!y.variantId&&((P=y.variants)!=null&&P[0])&&(D=y.variants[0].variant_id),Y([{...y,newSelectOptionList:[],quantity:parseInt(y.quantity.toString(),10)||1,variantId:D}])}};return n.jsx(Vt,{fullWidth:!0,isOpen:R,handleLeftClick:x,title:X,showRightBtn:!1,loading:O,maxWidth:"md",leftSizeBtn:d("shoppingLists.close"),children:n.jsx(xt,{isSpinning:O,children:n.jsxs(G,{sx:{minWidth:U?"initial":"100%",flex:1},children:[n.jsx(At,{hiddenLabel:!0,variant:"filled",fullWidth:!0,size:"small",value:e,onChange:B,onKeyDown:_,error:!L||L.length<=0,InputProps:{startAdornment:n.jsx(Dt,{position:"start",children:n.jsx($t,{})})},sx:{margin:"12px 0","& input":{padding:"12px 12px 12px 0"}}}),L&&L.length>0?n.jsx(de,{products:L,quantityEditable:!0,type:I,textAlign:U?"left":"right",canToProduct:!0,onProductQuantityChange:j,renderAction:S=>n.jsx(le,{product:S,onAddToListClick:z,onChooseOptionsClick:q,addButtonText:$}),actionWidth:"180px"}):n.jsx(gt,{children:"No products found"})]})})})}function Ie({updateList:v=()=>{},addToList:d,searchDialogTitle:R,addButtonText:W,type:e}){const L=bt(),B=N(({company:s})=>s.companyInfo.id),A=N(s=>s.company.customer.customerGroupId),j=N(({company:s})=>s.companyInfo.status),Y=N(({b2bFeatures:s})=>s.masqueradeCompany.id),q=B||Y,[O,I]=o.useState(!1),[X,$]=o.useState(!1),[M,U]=o.useState(!1),[x,_]=o.useState(""),[m,z]=o.useState([]),[S,y]=o.useState(!1),[P,D]=o.useState(),[ct]=Bt(),ot=s=>{_(s.target.value)},at=async()=>{if(!(!x||O)){if(ct&&j===0){nt.info(L("global.searchProductAddProduct.businessAccountPendingApproval"));return}I(!0);try{const{productsSearch:s}=await Et({search:x,companyId:q,customerGroupId:A,categoryFilter:!0}),g=te(s);z(g),$(!0)}finally{I(!1)}}},K=s=>{s.key==="Enter"&&at()},Z=()=>{at()},lt=()=>{z([])},tt=()=>{y(!1),$(!1),M&&(U(!1),v()),lt()},dt=(s,g)=>{const T=m.find(Q=>Q.id===s);T&&(T.quantity=g),z([...m])},i=async s=>{try{I(!0),await vt(s),await d(s),v()}finally{I(!1)}},l=async s=>{await i(s)},u=s=>{const g=m.find(T=>T.id===s);g&&D({...g}),$(!1),y(!0)},c=()=>{y(!1),$(!0)},b=async s=>{try{I(!0),await vt(s),await i(s),y(!1),$(!0)}catch(g){I(!1)}finally{I(!1)}};return n.jsxs(G,{sx:{margin:"24px 0"},children:[n.jsx(gt,{children:L("global.searchProductAddProduct.searchBySkuOrName")}),n.jsx(At,{hiddenLabel:!0,placeholder:L("global.searchProduct.placeholder.".concat(e)),variant:"filled",fullWidth:!0,size:"small",value:x,onChange:ot,onKeyDown:K,InputProps:{startAdornment:n.jsx(Dt,{position:"start",children:n.jsx($t,{})})},sx:{margin:"12px 0","& input":{padding:"12px 12px 12px 0"}}}),n.jsx(mt,{variant:"outlined",fullWidth:!0,disabled:O,onClick:Z,children:n.jsx(xt,{isSpinning:O,tip:"",size:16,children:n.jsx(G,{sx:{flex:1,textAlign:"center"},children:L("global.searchProductAddProduct.searchProduct")})})}),n.jsx(ue,{isOpen:X,isLoading:O,productList:m,searchText:x,type:e,onSearchTextChange:ot,onSearch:Z,onCancel:tt,onProductQuantityChange:dt,onChooseOptionsClick:u,onAddToListClick:l,searchDialogTitle:R,addButtonText:W}),n.jsx(ce,{isOpen:S,isLoading:O,type:e,setIsLoading:I,product:P,onCancel:c,onConfirm:b,addButtonText:W})]})}export{ce as C,Le as Q,Ie as S};
//# sourceMappingURL=SearchProduct-QYCximSM.js.map
